---
import { getLocale, getPath, locales } from '~/utils/i18n'

const currentLocale = getLocale(Astro)
const currentPath = Astro.url.pathname

const localeNames = {
  en: 'English',
  de: 'Deutsch',
  ja: 'Japanese',
} as const

const getLocaleName = (locale: string): string =>
  localeNames[locale as keyof typeof localeNames] || locale.toUpperCase()

const localeOptions = locales.map(locale => ({
  locale,
  name: getLocaleName(locale),
  path: getPath(locale)(currentPath),
  isActive: locale === currentLocale,
}))

const { class: className, isDark, ...props } = Astro.props

const uniqueId = `locale-dropdown-${Math.random().toString(36).substring(2, 9)}`
---

<div class="relative inline-block">
  <select
    id={uniqueId}
    aria-label="Select language"
    class:list={[
      'cursor-pointer rounded-xl border px-4 py-2 text-base transition hover:border-coral focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2',
      className,
      isDark ? 'border-dark bg-dark text-paper' : 'border-paper bg-paper text-dark',
    ]}
    {...props}
  >
    {
      localeOptions.map(({ locale, name, path, isActive }) => (
        <option value={path} selected={isActive}>
          {name}
        </option>
      ))
    }
  </select>
</div>

<script define:vars={{ uniqueId }}>
  const dropdown = document.getElementById(uniqueId)

  if (dropdown) {
    dropdown.addEventListener('change', event => {
      const target = event.target
      const selectedPath = target.value

      if (selectedPath) {
        window.location.href = selectedPath
      }
    })
  }
</script>
